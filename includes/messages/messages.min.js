const MessageForm={modal:null,saveclb:null,parent:null,editor:null,user:null,subject:null,init:function(e){this.editor=new PellEditor("#message_body"),this.parent=query('form#message input[name="parent_id"]'),this.subject=query('form#message input[name="subject"]'),this.user=query('form#message select[name="user_id"]'),bind('form#message input[name="cancel"]',"click",(e=>{this.cancel()})),bind("form#message","submit",(e=>{e.preventDefault(),this.save()})),this.modal=new ModalForm(e)},show:function(e,s=!1,t){this.saveclb=t,this.user.value=e.user_id,this.subject.value=e.subject,this.parent.value=e.parent_id??0,this.editor.setValue(e.body),s?(query("form#message table.form thead th").innerHTML="Répondre à "+e.from_name,document.getElementById("message_dest_row").style.display="none",document.getElementById("message_subject_row").style.display="none",setTimeout((()=>{this.editor.focus()}),200)):(query("form#message table.form thead th").innerHTML="Envoyer un message",document.getElementById("message_dest_row").style.display="",document.getElementById("message_subject_row").style.display="",setTimeout((()=>{this.user.focus()}),200)),this.modal.show()},hide:function(){this.modal.hide()},cancel:function(){this.hide()},save:function(){if(!striptags(decodeEntities(this.editor.value)).trim())return ModalBox.warning("Vous devez entrer le message.",(()=>{this.editor.focus()}));"function"==typeof this.saveclb&&this.saveclb({parent_id:this.parent.value,user_id:this.user.value,subject:this.subject.value,body:this.editor.value})}},app={params:null,list:null,init(e){this.params=e,this.list=query(".mlist"),this.params.messages.forEach((e=>{this.addMessage(e)})),bind("div.icon.outbox","click",(e=>{redirect("messages/envoyes")})),bind("div.icon.send","click",(e=>{this.newMessage()})),bind("div.icon.reply","click",(e=>{this.replyMessage(e.target.dataset.id)})),bind("ul.mlist li summary","click",(e=>{this.expandMessage(e)})),bind("ul.mlist li div.icon.trash","click",(e=>{this.deleteMessage(e.target.dataset.id)})),bind("div.scroll .scroll__up","click",(e=>{window.scrollTo(0,0)})),bind("div.scroll .scroll__down","click",(e=>{window.scrollTo(0,document.body.scrollHeight)})),MessageForm.init("#modal_message")},addMessage(e){let s="",t="",a=document.createElement("li");s+='<div class="icons">',parseInt(e.from_id)&&parseInt(e.from_id)!=parseInt(e.user_id)&&(s+='<div class="icon reply" data-id="'+e.id+'" title="Répondre"></div>&nbsp;'),s+='<div class="icon trash" data-id="'+e.id+'" title="Supprimer"></div></div>',s+="<h3>De: "+e.from_name+"&nbsp;<em>("+e.sent+")</em></h3>",s+="<h4>Sujet: "+e.subject+"</h4>","true"===localStorage.getItem("message_details_"+e.id)&&(t=" open"),s+="<details"+t+'><summary data-id="'+e.id+'">Voir le message</summary>'+e.body+"</details>",a.innerHTML=s,a.id="message_"+e.id,parseInt(e.unread)&&a.classList.add("unread"),this.list.appendChild(a)},deleteMessage(e){ModalBox.confirm("Êtes-vous sur de vouloir supprimer ce message?",(()=>{let s=this.getMessage(e);document.getElementById("message_"+s.id).remove(),localStorage.removeItem("message_details_"+s.id),parseInt(s.unread)&&this.refreshMailbox(),post({action:"delete",id:e})}))},getMessage(e){let s=null;return this.params.messages.every((t=>{if(t.id!=e)return!0;s=t})),s},expandMessage(e){let s=this.getMessage(e.target.dataset.id);parseInt(s.unread)&&(document.getElementById("message_"+s.id).classList.remove("unread"),this.refreshMailbox(),s.unread=0,post({action:"read",id:s.id})),e.target.parentElement.open?localStorage.removeItem("message_details_"+e.target.dataset.id):localStorage.setItem("message_details_"+e.target.dataset.id,"true")},getUnreadMessages:()=>query("ul.mlist li.unread",!0).length,refreshMailbox(){this.getUnreadMessages()||query("header div.mail").classList.remove("new")},newMessage(){MessageForm.show({user_id:"",subject:"",body:""},!1,(e=>{e.action="send",post(e),MessageForm.hide(),ModalBox.plane()}))},replyMessage(e){let s=this.getMessage(e);/^RE:/.test(s.subject)||(s.subject="RE: "+s.subject),MessageForm.show({user_id:parseInt(s.from_id),from_name:s.from_name,parent_id:parseInt(s.id),subject:s.subject,body:""},!0,(e=>{e.action="reply",post(e),MessageForm.hide(),ModalBox.plane()}))}};