const MessageForm={modal:null,saveclb:null,parent:null,editor:null,user:null,subject:null,init:function(e){this.editor=new PellEditor("#message_body"),this.parent=query('form#message input[name="parent_id"]'),this.subject=query('form#message input[name="subject"]'),this.user=query('form#message select[name="user_id"]'),bind('form#message input[name="cancel"]',"click",(e=>{this.cancel()})),bind("form#message","submit",(e=>{e.preventDefault(),this.save()})),this.modal=new ModalForm(e)},show:function(e,s=!1,t){this.saveclb=t,this.user.value=e.user_id,this.subject.value=e.subject,this.parent.value=e.parent_id??0,this.editor.setValue(e.body),s?(document.getElementById("message_dest_row").style.display="none",document.getElementById("message_subject_row").style.display="none",setTimeout((()=>{this.editor.focus()}),200)):(document.getElementById("message_dest_row").style.display="",document.getElementById("message_subject_row").style.display="",setTimeout((()=>{this.user.focus()}),200)),this.modal.show()},hide:function(){this.modal.hide()},cancel:function(){this.hide()},save:function(){if(!striptags(decodeEntities(this.editor.value)).trim())return ModalBox.warning("Vous devez entrer le message.",(()=>{this.editor.focus()}));"function"==typeof this.saveclb&&this.saveclb({parent_id:this.parent.value,user_id:this.user.value,subject:this.subject.value,body:this.editor.value})}},app={params:null,list:null,init(e){this.params=e,this.list=query(".mlist"),this.params.messages.forEach((e=>{this.addMessage(e)})),bind("div.icon.inbox","click",(e=>{redirect("messages")})),bind("div.icon.send","click",(e=>{this.newMessage()})),bind("ul.mlist li summary","click",(e=>{this.expandMessage(e)})),bind("div.scroll .scroll__up","click",(e=>{window.scrollTo(0,0)})),bind("div.scroll .scroll__down","click",(e=>{window.scrollTo(0,document.body.scrollHeight)})),MessageForm.init("#modal_message")},addMessage(e){let s="",t="",i=document.createElement("li");s+="<h3>Ã€: "+e.user_name+"&nbsp;<em>("+e.sent+")</em></h3>",s+="<h4>Sujet: "+e.subject+"</h4>","true"===localStorage.getItem("message_details_"+e.id)&&(t=" open"),s+="<details"+t+'><summary data-id="'+e.id+'">Voir le message</summary>'+e.body+"</details>",i.innerHTML=s,i.id="message_"+e.id,parseInt(e.unread)&&i.classList.add("unread"),this.list.appendChild(i)},getMessage(e){let s=null;return this.params.messages.every((t=>{if(t.id!=e)return!0;s=t})),s},expandMessage(e){e.target.parentElement.open?localStorage.removeItem("message_details_"+e.target.dataset.id):localStorage.setItem("message_details_"+e.target.dataset.id,"true")},newMessage(){MessageForm.show({user_id:"",subject:"",body:""},!1,(e=>{e.action="send",post(e),MessageForm.hide(),ModalBox.plane((()=>{location.reload()}))}))}};